<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hagelloch Measles -- Fitting a Stochastic SIR Model • EpiCompare</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Hagelloch Measles -- Fitting a Stochastic SIR Model">
<meta property="og:description" content="EpiCompare">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">EpiCompare</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/getting-started.html">Getting started</a>
    </li>
    <li>
      <a href="../../articles/not-built-vignettes/ternary-plots-explained.html">An Introduction to Ternary Plots</a>
    </li>
    <li>
      <a href="../../articles/not-built-vignettes/comparing-bands-and-assessing-containment.html">Comparing Models (to Models) and Epidemics (to Models)</a>
    </li>
    <li>
      <a href="../../articles/not-built-vignettes/depths-impact-on-prediction-bands.html">Understanding Prediction Bands and the Impact of Quantile Functions</a>
    </li>
    <li>
      <a href="../../articles/not-built-vignettes/example-epimodel.html">Using EpiModel models with EpiCompare</a>
    </li>
    <li>
      <a href="../../articles/not-built-vignettes/basic-abm.html">Basic simulations with EpiCompare</a>
    </li>
    <li class="divider">
    <li>
      <a href="../../articles/index.html">More...</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/skgallagher/EpiCompare/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="hagelloch-sir-stochastic_files/header-attrs-2.3/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Hagelloch Measles – Fitting a Stochastic SIR Model</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/skgallagher/EpiCompare/blob/master/vignettes/not-built-vignettes/hagelloch-sir-stochastic.Rmd"><code>vignettes/not-built-vignettes/hagelloch-sir-stochastic.Rmd</code></a></small>
      <div class="hidden name"><code>hagelloch-sir-stochastic.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>In this series of vignettes, we will demonstrate epidemic analysis pipeline from EDA to dissemination using a case study of measles.</p>
</div>
<div id="the-epidemic-analysis-pipeline" class="section level2">
<h2 class="hasAnchor">
<a href="#the-epidemic-analysis-pipeline" class="anchor"></a>The Epidemic Analysis Pipeline</h2>
<p><img src="images/pipeline1.png"></p>
</div>
<div id="hagelloch-series-vignettes" class="section level2">
<h2 class="hasAnchor">
<a href="#hagelloch-series-vignettes" class="anchor"></a>Hagelloch series vignettes</h2>
<p><a href="hagelloch-eda.html">Hagelloch 1 Pre-processing and EDA</a></p>
<p><a href="hagelloch-mods.html">Hagelloch 2.1 Modeling and Simulation: the SIR model</a></p>
<p><a href="hagelloch-sir-fit.html">Hagelloch 2.2 Modeling and Simulation: fitting a SIR model</a></p>
<p><strong><a href="hagelloch-sir-stochastic.html">Hagelloch 2.3.1 Modeling and Simulation: a stochastic SIR model</a></strong></p>
<p><a href="hagelloch-sir-stochastic-three-groups.html">Hagelloch 2.3.2 Modeling and Simulation: a stochastic SIR model</a></p>
<p><a href="hagelloch-other-mods.html">Hagelloch 2.4 Modeling and Simulation with other packages</a></p>
</div>
<div id="goals-in-this-vignette" class="section level2">
<h2 class="hasAnchor">
<a href="#goals-in-this-vignette" class="anchor"></a>Goals in this vignette</h2>
<ol style="list-style-type: decimal">
<li><p>Introduce a discrete time, stochastic SIR model.</p></li>
<li><p>Derive the likelihood</p></li>
<li><p>Find parameters that maximize the likelihood for the Hagelloch data.</p></li>
<li><p>Simulate SIR models from the best fit model</p></li>
</ol>
</div>
<div id="a-discrete-time-stochastic-sir-model" class="section level2">
<h2 class="hasAnchor">
<a href="#a-discrete-time-stochastic-sir-model" class="anchor"></a>A discrete time, stochastic SIR model</h2>
<p>In the <a href="hagelloch-sir-fit.html">previous vignette</a>, we looked at the continuous time Kermack and McKendrick SIR model. This model described how individuals moved from susceptible to infectious to recovered states, according to a series of ordinary differential equations.</p>
<p>We transform this continuous time, deterministic SIR model to a discrete time, stochastic one. The first step is changing the <span class="math inline">\(d\)</span>s to <span class="math inline">\(\Delta\)</span>s, or more formally using a first order approximation of ODEs.</p>
<p><span class="math display">\[
\frac{\Delta S(t)}{\Delta t} = \frac{S(t) - S(t-1)}{\Delta t} = - \beta S(t-1)I(t-1)\\
\frac{\Delta I(t)}{\Delta t} = \frac{I(t) - I(t-1)}{\Delta t} =  \beta S(t-1)I(t-1) - \gamma I(t-1)\\
\frac{\Delta R(t)}{\Delta t} = \frac{R(t) - R(t-1)}{\Delta t} = \gamma I(t-1)
\]</span></p>
<p>We will assume <span class="math inline">\(\Delta t = 1\)</span>. The next step is introducing random error to the model. Specifically, we refer to process error, which is error inherent in the transmission process, as opposed to error introduced by systemic error in measuring the data.</p>
<p>There are a number of ways to model the number of individuals moving from state to state from one time step to the next, but some of most common are Binomial and Poisson random variables. We analyze the process with Binomial random variables, conditioned on the previous state values. Given an initial set of values <span class="math inline">\((X_S(0), X_I(0), X_R(0)\)</span>, the number of individuals moving from one state to another from time <span class="math inline">\(t-1\)</span> to <span class="math inline">\(t\)</span> for <span class="math inline">\(t &gt;0\)</span> are given by the following equations <span class="math display">\[
Z_{SI}(t)| X_S(t-1), X_I(t-1) \sim Binomial \left (X_S(t-1), \beta X_I(t-1) \right )\\
Z_{IR}(t)|  X_I(t-1) \sim Binomial \left (X_I(t-1), \gamma \right ).
\]</span> The number of individuals moving from the susceptible state to the infectious state from time <span class="math inline">\(t-1\)</span> to <span class="math inline">\(t\)</span>, <span class="math inline">\(Z_{SI}(t)\)</span> is choosing from the <span class="math inline">\(X_S(t-1)\)</span> susceptibles and with probability of <span class="math inline">\(\beta I(t-1)\)</span> draws a number of them to become infectious. Similarly, <span class="math inline">\(Z_{IR}(t)\)</span> chooses from the <span class="math inline">\(X_I(t-1)\)</span> infected individuals with probability <span class="math inline">\(\gamma\)</span> to recover. This means <span class="math inline">\(\beta I(t-1)\)</span> and <span class="math inline">\(\gamma\)</span> have to be constrained between zero and one, to have a properly specified distribution.</p>
<p>The new number in each state is then given by the following: <span class="math display">\[
X_S(t) = X_S(t-1) - Z_{SI}\\
X_I(t) = X_I(t-1) + Z_{SI} - Z_{IR}\\
X_R(t) = X_R(t-1) + Z_{IR}.
\]</span></p>
<p>One benefit of this approach, is that <span class="math inline">\(E[(X_S(t), X_I(t), X_R(t))] = (S(t), I(t), R(t))\)</span> for all <span class="math inline">\(t\)</span>, and the variance can be calculated. More details of this are shown in <span class="citation">Gallagher (2019)</span>.</p>
</div>
<div id="calculating-the-likelihood" class="section level2">
<h2 class="hasAnchor">
<a href="#calculating-the-likelihood" class="anchor"></a>Calculating the likelihood</h2>
<p>We denote the set of observed data (the number of individuals in each state at time <span class="math inline">\(t\)</span> for <span class="math inline">\(t=0, \dots, T\)</span>) as <span class="math inline">\(\boldsymbol{x}\)</span>. We let <span class="math inline">\(p_t = \beta X_I(t)\)</span> be the probability of becoming infected from time <span class="math inline">\(t-1\)</span> to <span class="math inline">\(t\)</span>. The likelihood is then proportional to <span class="math display">\[
\mathcal{L}(\beta, \gamma; \boldsymbol{x}) = \prod_{t=1}^T p_{t-1}^{S(t-1) - S(t)} \left [1-p_{t-1} \right ]^{S(t)} \times \gamma^{R(t) - R(t-1)}(1-\gamma)^{I(t-1) - (R(t)-R(t-1))},
\]</span> where the exponents are <em>non-random</em> quantities, but rather completely determined by the initial values and <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\gamma\)</span>. The log likelihood is then</p>
<p><span class="math display">\[
\ell(\beta, \gamma, x) = \sum_{t=1}^T \left (S(t-1) - S(t) \right)\log(p_{t-1}) + S(t)\log\left (1-p_{t-1} \right )  + \left ({R}(t) - R(t-1) \right)\log(\gamma)  + \left (I(t-1) - (R(t) - R(t-1)) \right )\log(1 - \gamma).
\]</span></p>
<p>An approximation to the above log likelihood is substituting the <em>data</em> <span class="math inline">\(x_S(t)\)</span>, <span class="math inline">\(x_I(t)\)</span>, and <span class="math inline">\(x_R(t)\)</span> for <span class="math inline">\(S(t), I(t)\)</span>, and <span class="math inline">\(R(t)\)</span>, respectively, which is what we do below (because it is easier to compute for demonstrative purposes).</p>
<p>After loading the libraries,</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyerse</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">EpiCompare</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">knitr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">kableExtra</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">RColorBrewer</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">deSolve</span>)</pre></body></html></div>
<p>we get the aggregate SIR data from <code>hagelloch_raw</code> and define our deterministic, continuous time SIR model.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="co">## Getting aggregate data</span>
<span class="no">aggregate_hag</span> <span class="kw">&lt;-</span> <span class="no">hagelloch_raw</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../../reference/agents_to_aggregate.html">agents_to_aggregate</a></span>(<span class="kw">states</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">tI</span>, <span class="no">tR</span>),
                      <span class="kw">min_max_time</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">55</span>)) <span class="kw">%&gt;%</span>
   <span class="fu">rename</span>(<span class="kw">time</span> <span class="kw">=</span> <span class="no">t</span>, <span class="kw">S</span> <span class="kw">=</span> <span class="no">X0</span>, <span class="kw">I</span> <span class="kw">=</span> <span class="no">X1</span>, <span class="kw">R</span> <span class="kw">=</span> <span class="no">X2</span>)</pre></body></html></div>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="co">#' Calculate the SIR log like from above eq.</span>
<span class="co">#' </span>
<span class="co">#' @param par parameters to optimize</span>
<span class="co">#' @param data a data frame containing columns time, S, I, and R</span>
<span class="co">#' return log like for given parameters</span>
<span class="no">sir_loglike</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">par</span>, <span class="no">data</span>){
  <span class="no">data</span>$<span class="no">beta</span> <span class="kw">&lt;-</span> <span class="no">par</span>[<span class="fl">1</span>]
  <span class="no">data</span>$<span class="no">gamma</span> <span class="kw">&lt;-</span> <span class="no">par</span>[<span class="fl">2</span>]
  <span class="no">data</span>$<span class="no">N</span> <span class="kw">&lt;-</span> <span class="no">data</span>$<span class="no">S</span> + <span class="no">data</span>$<span class="no">I</span> + <span class="no">data</span>$<span class="no">R</span>
  <span class="no">data_new</span> <span class="kw">&lt;-</span> <span class="no">data</span> <span class="kw">%&gt;%</span>
    <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">delta_S</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span>(<span class="no">S</span>)),
           <span class="kw">delta_R</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span>(<span class="no">R</span>)),
           <span class="kw">prev_S</span> <span class="kw">=</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span>(<span class="no">S</span>),
           <span class="kw">prev_I</span> <span class="kw">=</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span>(<span class="no">I</span>),
           <span class="kw">prev_R</span> <span class="kw">=</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span>(<span class="no">R</span>),
           <span class="kw">prob_inf</span> <span class="kw">=</span> <span class="no">beta</span> / <span class="no">N</span> * <span class="no">prev_I</span>,
           <span class="kw">loglike_SI_init</span> <span class="kw">=</span> (-<span class="no">delta_S</span>) * <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="no">prob_inf</span>) +
              <span class="no">S</span> * <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fl">1</span> - <span class="no">prob_inf</span>),
           <span class="kw">loglike_SI</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">prev_I</span> <span class="kw">==</span> <span class="fl">0</span>, <span class="fl">0</span>,
                                <span class="no">loglike_SI_init</span>),
           <span class="kw">loglike_IR</span> <span class="kw">=</span> (<span class="no">delta_R</span>) * <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="no">gamma</span>) + (<span class="no">prev_I</span> - <span class="no">delta_R</span>) * <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fl">1</span> - <span class="no">gamma</span>),
           <span class="kw">loglike</span> <span class="kw">=</span>  <span class="no">loglike_SI</span> + <span class="no">loglike_IR</span>
           )  <span class="kw">%&gt;%</span>
    <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">time</span> <span class="kw">!=</span> <span class="fl">0</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">data_new</span>$<span class="no">loglike</span>))
}</pre></body></html></div>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">init_params</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.1</span>, <span class="fl">.05</span>)

<span class="no">best_params</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span>(<span class="kw">par</span> <span class="kw">=</span> <span class="no">init_params</span>, <span class="kw">fn</span> <span class="kw">=</span> <span class="no">sir_loglike</span>,
                     <span class="kw">control</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">fnscale</span> <span class="kw">=</span> -<span class="fl">1</span>), <span class="co"># switches from minimizing function to maximizing it</span>
                     <span class="kw">data</span> <span class="kw">=</span> <span class="no">aggregate_hag</span>,
                     <span class="kw">hessian</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">best_params</span>$<span class="no">par</span>, <span class="kw">digits</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<pre><code>## [1] 0.36 0.13</code></pre>
</div>
<div id="simulating-new-outbreaks" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-new-outbreaks" class="anchor"></a>Simulating new outbreaks</h2>
<p>Now that we have the best (point) estimate for <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\gamma\)</span>, we can simulate new data.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">2020</span>)
<span class="co">## This is the SIR representation</span>
<span class="no">trans_mat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"X0 * (1 - X1 * par1 / N)"</span>, <span class="st">"X0 * X1  * par1 / N"</span>, <span class="st">"0"</span>,
                  <span class="st">"0"</span>, <span class="st">"X1 * (1 - par2)"</span>, <span class="st">"par2 * X1"</span>,
                  <span class="st">"0"</span>, <span class="st">"0"</span>, <span class="st">"X2"</span>), <span class="kw">byrow</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="fl">3</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">trans_mat</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>)
<span class="no">init_vals</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">187</span>, <span class="fl">1</span>, <span class="fl">0</span>)
<span class="no">par_vals</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">par1</span> <span class="kw">=</span> <span class="no">best_params</span>$<span class="no">par</span>[<span class="fl">1</span>], <span class="kw">par2</span> <span class="kw">=</span> <span class="no">best_params</span>$<span class="no">par</span>[<span class="fl">2</span>])
<span class="no">max_T</span> <span class="kw">&lt;-</span> <span class="fl">55</span>
<span class="no">n_sims</span> <span class="kw">&lt;-</span> <span class="fl">100</span>

<span class="no">abm</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/simulate_agents.html">simulate_agents</a></span>(<span class="no">trans_mat</span>,
                       <span class="no">init_vals</span>,
                       <span class="no">par_vals</span>,
                       <span class="no">max_T</span>,
                       <span class="no">n_sims</span>,
                       <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>)

<span class="no">agg_model</span> <span class="kw">&lt;-</span> <span class="no">abm</span> <span class="kw">%&gt;%</span> <span class="fu">group_by</span>(<span class="no">sim</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../../reference/agents_to_aggregate.html">agents_to_aggregate</a></span>(<span class="kw">states</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">I</span>, <span class="no">R</span>))</pre></body></html></div>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu">ggplot</span>() +
    <span class="fu"><a href="../../reference/geom_prediction_band.html">geom_prediction_band</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">agg_model</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">t</span> <span class="kw">!=</span> <span class="fl">0</span>),
         <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">X0</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">X1</span>, <span class="kw">z</span> <span class="kw">=</span> <span class="no">X2</span>,
              <span class="kw">sim_group</span> <span class="kw">=</span> <span class="no">sim</span>),
         <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">.5</span>,
         <span class="kw">conf_level</span> <span class="kw">=</span> <span class="fl">.9</span>,
         <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"cornflowerblue"</span>) +
    <span class="fu">coord_tern</span>() + <span class="fu"><a href="../../reference/theme_sir.html">theme_sir</a></span>() +
  <span class="fu">geom_point</span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">aggregate_hag</span>,
             <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">S</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">I</span>, <span class="kw">z</span> <span class="kw">=</span><span class="no">R</span>), <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>) +
  <span class="fu">labs</span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">"Prediction band for best parameters and original data"</span>)</pre></body></html></div>
<pre><code>## Coordinate system already present. Adding new coordinate system, which will replace the existing one.</code></pre>
<pre><code>## Warning: Ignoring unknown aesthetics: z</code></pre>
<pre><code>## Due to dist_params$dist_approach = "equa_dist", this may take a little while - see `filament_compression` examples for a work-around if you're making this plot multiple times</code></pre>
<p><img src="hagelloch-sir-stochastic_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>The result of this is a prediction band that does not fit the data well.</p>
<p>However, the above prediction band only contains the simulations resulting from the point estimates of <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\gamma\)</span>.</p>
<p>We will repeat this process by first simulating <span class="math display">\[
(\beta, \gamma)^{sim} \sim MVN\left ((\hat{\beta}, \hat{\gamma}), \hat{\boldsymbol{\Sigma}}\right )
\]</span> where <span class="math inline">\((\hat{\beta}, \hat{\gamma})\)</span> is the MLE and <span class="math inline">\(\hat{\boldsymbol{\sigma}}\)</span> is the variance-covariance (estimated from the Fisher Information approximation from the optimization process)</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">MASS</span>)</pre></body></html></div>
<pre><code>## 
## Attaching package: 'MASS'</code></pre>
<pre><code>## The following object is masked from 'package:dplyr':
## 
##     select</code></pre>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">sigma</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span>(-<span class="no">best_params</span>$<span class="no">hessian</span>)
<span class="no">mu</span> <span class="kw">&lt;-</span> <span class="no">best_params</span>$<span class="no">par</span>

<span class="no">B</span> <span class="kw">&lt;-</span> <span class="fl">100</span>
<span class="no">sim_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span>(<span class="kw">mode</span> <span class="kw">=</span> <span class="st">"list"</span>, <span class="kw">length</span> <span class="kw">=</span> <span class="no">B</span>)
<span class="no">par_val_mat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html">mvrnorm</a></span>(<span class="kw">n</span> <span class="kw">=</span> <span class="no">B</span>, <span class="kw">mu</span> <span class="kw">=</span> <span class="no">mu</span>, <span class="kw">Sigma</span> <span class="kw">=</span> <span class="no">sigma</span>)

<span class="kw">for</span>(<span class="no">bb</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="no">B</span>){

  <span class="no">par_vals</span> <span class="kw">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"par1"</span> <span class="kw">=</span> <span class="no">par_val_mat</span>[<span class="no">bb</span>, <span class="fl">1</span>],
                 <span class="st">"par2"</span> <span class="kw">=</span> <span class="no">par_val_mat</span>[<span class="no">bb</span>, <span class="fl">2</span>])


  <span class="no">abm</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../../reference/simulate_agents.html">simulate_agents</a></span>(<span class="kw">trans_mat</span> <span class="kw">=</span> <span class="no">trans_mat</span>,
                       <span class="kw">init_vals</span> <span class="kw">=</span> <span class="no">init_vals</span>,
                       <span class="kw">par_vals</span> <span class="kw">=</span> <span class="no">par_vals</span>,
                       <span class="no">max_T</span>,
                       <span class="kw">n_sims</span> <span class="kw">=</span> <span class="fl">2</span>,
                       <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
  <span class="no">agg_model</span> <span class="kw">&lt;-</span> <span class="no">abm</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../../reference/agents_to_aggregate.html">agents_to_aggregate</a></span>(<span class="kw">states</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">I</span>, <span class="no">R</span>))
  <span class="no">agg_model</span>$<span class="no">sim</span> <span class="kw">&lt;-</span> <span class="no">bb</span>
  <span class="no">agg_model</span>$<span class="no">beta</span> <span class="kw">&lt;-</span> <span class="no">par_vals</span>[<span class="fl">1</span>]
  <span class="no">agg_model</span>$<span class="no">gamma</span> <span class="kw">&lt;-</span> <span class="no">par_vals</span>[<span class="fl">2</span>]
  <span class="no">sim_list</span><span class="kw">[[</span><span class="no">bb</span>]] <span class="kw">&lt;-</span> <span class="no">agg_model</span>

}

<span class="no">sim_df</span> <span class="kw">&lt;-</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(<span class="no">sim_list</span>)</pre></body></html></div>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">plot_df</span> <span class="kw">&lt;-</span> <span class="no">sim_df</span> <span class="kw">%&gt;%</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">t</span> <span class="kw">!=</span> <span class="fl">0</span>) <span class="kw">%&gt;%</span>
                           <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">sim</span>, <span class="no">t</span>, <span class="no">X0</span>, <span class="no">X1</span>, <span class="no">X2</span>)

<span class="co">#bad_cat &lt;- names(table(plot_df$sim)[table(plot_df$sim) &lt; 55])</span>

<span class="fu">ggplot</span>() +
    <span class="fu"><a href="../../reference/geom_prediction_band.html">geom_prediction_band</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">plot_df</span>,
                         <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">X0</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">X1</span>, <span class="kw">z</span> <span class="kw">=</span> <span class="no">X2</span>,
                             <span class="kw">sim_group</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">sim</span>)),
                         <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">.5</span>,
                         <span class="kw">conf_level</span> <span class="kw">=</span> <span class="fl">.9</span>,
                         <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"cornflowerblue"</span>,
                         <span class="kw">pb_type</span> <span class="kw">=</span> <span class="st">"delta_ball"</span>) +
    <span class="fu">coord_tern</span>() + <span class="fu"><a href="../../reference/theme_sir.html">theme_sir</a></span>() +
  <span class="fu">geom_point</span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">aggregate_hag</span>,
             <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">S</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">I</span>, <span class="kw">z</span> <span class="kw">=</span><span class="no">R</span>), <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>) +
  <span class="fu">labs</span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">"Prediction band for best parameters and original data"</span>)</pre></body></html></div>
<pre><code>## Coordinate system already present. Adding new coordinate system, which will replace the existing one.</code></pre>
<pre><code>## Warning: Ignoring unknown aesthetics: z</code></pre>
<pre><code>## Due to dist_params$dist_approach = "equa_dist", this may take a little while - see `filament_compression` examples for a work-around if you're making this plot multiple times</code></pre>
<p><img src="hagelloch-sir-stochastic_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references hanging-indent">
<div id="ref-gallagher2019">
<p>Gallagher, Shannon K. 2019. “Catalyst: Agents of Change. Integration of Compartment and Agent-Based Models for Use in Infectious Disease Methodology.” PhD thesis, Carnegie Mellon University. <a href="https://skgallagher.github.io/papers/gallagher_dissertation.pdf">https://skgallagher.github.io/papers/gallagher_dissertation.pdf</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://skgallagher.github.io/">Shannon Gallagher</a>, <a href="https://benjaminleroy.github.io/">Benjamin LeRoy</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
